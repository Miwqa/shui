Marlin 2, SHUI Beta 0.1

Ранние версии : https://github.com/vyacheslav-shubin/mks-robin-nano35-binary/tree/master/m2-alpha


С 2021.04.09 файлы *_config.gcode заменены на @*.gcode, далее по тексту следует это учитывать.
Файлы начинающиеся на @ рассматриваются прошивкой как файлы конфигурации.

Бета версия прошивки для MKS_ROBIN_NANO.
Прошивка и сопутствующие дополнения к ней состоит из файлов:
  robin_nano35.bin  - собственно код прошивки
  RESDUMP.BIN       - картинки, шрифты, прочие ресурсы
  Файлы расположены в каталоге firmware. На флешка для прошивки они должны находиться в корне. Файлы Configuration.h приложены справочно, и для прошивки не требуются.
  сfg/@printer.gcode      - конфигурация
  cfg/@pid.gcode - демонстрационный файл конфигурирования PID термостатов. При запуске файла включается специальный виджет, показывающий динамику температуры
  preview-test - тестовые файлы для проверки алгоритмов превью
  SHUIWIFI.BIN - прошивка модуля WiFi
  
  
  !!!! только для MKS ROBIN 1.1 с модулем wifi
  ROBIN11.BIN - Этот файл используется как маркерный для определения типа материноской платы в момент прошивки WiFi модуля.
	MKS ROBIN 1.1 и MKS ROBIN 1.2 используют разные порты для перевода модуля WiFi в режим прошивки.
	Для MKS ROBIN 1.1 во время прошивки файл должен находиться в корне флешки. Содержание файла не имеет значения.
	
	

  
  ROBIN11.BIN, SHUIWIFI.BIN, RESDUMP.BIN не следует переименовывать с использованием маленьких букв. marlin2 не поддерживает удаление и изменение имен файлов с длинными именами,
  это не отностится к robin_nano35.bin - так как он используется бутлоадером платы, а не Marlin
  
  cura.zip - плагин для CURA и сценарий создания превью в файле g кода.
  
  ShuiPreview.py - скрипт для CURA, создающий preview. Поддерживается собственный формат и формат от MKS, 
	малые превью файлов могут быть двух размеров: 100x100 и 50х50 - кому уж как навится.
	Скрипт устанавливается в <Cura configuration>/scripts (меню HELP/Cura configuration). 
	Плагин от mks лучше удалить, чтобы не путаться в переключателях Save to File и Save as TFT
	
	Использование скрипта:
		Extensions/Post processing/Modify G-code
		Add a script/Generate SHUI Preview
	При сохранении G кода в файл будет добавлены строки описывающие превью.
	Какой формат выбрать?
		Если файл будет печататься на принтере с прошивкой SHUI, то формат SHUI, если это будут и принтеры с прошивкой от MKS, то формат MKS
		Прошивка shui поддерживает оба формата (с учетом размера превью - 4 формата), прошивка от MKS в зависимости от версии только mks50 или mks100
	Преимущество формата SHUI:
		Использовано кодирование base64, что дает избыточность кода 4/3, в отличии от MKS где кодировка HEX с избыточностью 2/1,
		что делает файлы с g кодом несколько меньше объемом.
  Плагин "Send to SHUI WIFI"
  	В адресной строке задается IP адрес принтера. В строке имени файла необходимо задать не более 8 символов допустимых в формате 
	имени файла 8.3 (большие латинсие буквы, цифры, некоторые знаки). Данный формат пока не контролируется, и в случае его нарушения загрузка файла може закончится ошибкой
	
	

Использование памяти EEPROM отличается от версии MKS, поэтому, 
при обратной прошивке требуется полная инициализация:
  /mks_pics
  /mks_fonts
  robin_nano35.bin
  robin_nano_config.txt


Особенности:
Концевики X-min, Y-max, Z-min

Все настройки в настоящий момент делаются через g код. После прошивки запустить вручную.
О выполнении конфигурирования будет сообщено в статусной строке: settings stored
Предварительно настроенный 
Специфичные настройки прошивки задаются через "M117 SHUI "

2021-02-02
-Можно печатать
-Виджет выбора файлов имеет два вида
-Конфигурирование сигнала концевиков
-Размер стола и оси Z задается через GCODE 
      M117 SHUI M2001 X220 Y220 Z250  ;set machine size
-Точки для ручного уровня стола задаются через
      M117 SHUI M2002 S0 X20 Y20      ;set manual leveling point
-Поддержка настроек пресетов для пластика:
      M145 S0 B61 H201
      M145 S1 B91 H231
      M145 S2 B76 H241
      M145 S3 B111 H210
-Ограничение длины отображения строки (за предоставленный размер не залезает)


2021-02-02 2
-Виджет конфигурирования инверсии осей. 
-Поддержка G кода конфигурирования инверсии осей и состяния концевых датчиков 
  M117 SHUI M2003 X1 Y1 Z1 T0 E1      ;Axis invertion (1 - inverted)
  M117 SHUI M2004 S1 X0 Y1 Z0       ;Endstop passive level (S-1-MAX/0-MIN enstop)
  M117 SHUI M2004 S0 X1 Y0 Z1  
-Исправлана ошибка выделения памяти для отлисовки букв загружаемого шрифта

2021-02-03 
-Кнопка выключения питания
-Виджет печати - пиктограммы состояния

2021-02-04
-Виждет перемещения хотэнда
-Поддержка сниппетов
-Файл ресурсов с контрольной суммой и сигнатурой
-Включен LINEAR ADVANCE

2021-02-06
-Калькулятор
-Браузер файлов, расширения файлов не отображаются
-Браузер файлов, поддержка файлов _config.gcoge
-Виджет конфигурирвания размера принтера

2021-02-08
-Управление питанием
    -ожидание охлаждения хотэнда будет реализовано чуть позже
-Конфигурирование параметров управления питанием через G код (см. конфиг)
-Виджет настройки длины притка для команд загрузки/выгрузки
-Сниппет выключения питания 
    POWER_OFF=M81
-Поддержка M0/M1 - диалоговое окно с ожиданием нажатия.
-По окончанию исполнения файлов конфигурации браузер файлов не закрывается

2021-02-09
-Новый виджет перемещения. Совмещает парковку, управление филаментом, передвижение

2021-02-10
-Сниппеты конфигурируются из g-кода
-Виджеты работают через сниппеты. Без однократного запуска после прошивки конфигурирущего файла интерфейс работать не будет.
-В конфигурационном файле можно настроить основные действия по нажатию на кнопки интерфейса. Начальная конфигурция задана
-Если в новом виджете перемещения выбрать ось E0(E1) - экструдер, и максимальную дистанцию перемещения, сработают сниппеты FILAMENT_LOAD 17, FILAMENT_UNLOAD 18
-Длина сниппета не более 64 символов. Если сниппет содержит поле для подстановки значения, следует учитывать его увеличивающуюся длину, после заполнения.

2021-02-11
-Превью файлов в браузере

2021-02-12
-Превью в виджете печати

2021-02-12
-Пиктограммы активных процессов (печать, парковка, нагрев, срабатывание концевых датчиков)
-Предварительный просмотр печатаемого фала, метаинформация о размере модели, к-ва филамента, времени печати
-Виджет переключения языка. (строковые константы не опрелены, язык переключается только на первом виджете)
-Диалог выключения принтера отформатирован

2021-02-15
-Калькулятор присоединен к пиктограммам с температурой, вентилятором. Можно менять значения.
-В виджете перчати добавлена информация о расходе филамента.
-Превью печатаемой модели активно в виджете печати. При нажатии отображается статистика. (черновой вариант, требуется форматирование)

2021-02-16
-Виджет Home. Пользовательские кнопки (сниппет 40-43)
-Ручная настройка уровней стола - 9 точек
-Запуск файла конфигурации обязателен

2021-02-17
-Диалог-виджет "Информация"
-Заготовка к "Управление нагревом"
-Заготовка к "Управление филаментом"

2021-02-18
-Виджет управления филаментом
-Кнопки пользовательских сниппетов не отображаются, если сниппет не задан.
-Виджет графика температуры


2021-02-19
-Установка/сброс флагов состояния через G-код
-Виджет управления нагревом
-Виджет подстройки печати (начало)


2021-02-21
-M300 - пикалка пикает
-Виджет управления параметрами печати. На ходу можно поправить скорость печати, подачу пластика, коэфициент la...
-Доработка виджета конфигурирования
-Виджет Управление вентиляторами (начало)
-Виджет настройки wiFI (начало)

2021-02-24
-Украинский язык
-Доделан виджет управления вентилятором
-В конфигурации парковки инструмента можно задать длину ретракта филамента
-Функция "Пауза" (надо тестировать во время печати)

2021-02-24
-Выравнивание текста по центру для больших кнопок

2021-03-01
-Обновление WiFi модуля, файлы 0x00000.bin,  0x10000.bin
-M117 SHUI M25 - пауза печати, передача управления UI, возможность возобновления печати

2021-03-05
-WiFi NTP

2021-03-08
-Выбор сети WiFi
  При установке значения SSID сети или пароля происходит сброс модуля wifi. Иницализания модуля требует нескольких секунд. В случае возможна задержка поиска сетей на 2-3 секунды.
-6 срок виджеты конфигурации
-Виджет задания значений PID и лимита температур
M117 SHUI M414 S1 - установка языка. 0 - английский, 1 - русский, 2 - украинский

2021-03-09
-Автовыключение дисплея (время настраивается)
-Инициализация калькулятора в 0 (настраивается)
-Событийное взаимодействие с модулем WiFi

2021-03-09
-NTP
-Wifi виджет - состояние подключения модуля WiFi
-Обновление модуля WiFi в любом случае, если найдены файлы прошивки. (Было если включена опция наличия модуля WiFi)
-Wifi UART bridge - Приветственная строка с версиями

2021-03-11
-Marlin bugfix-2.0.x-2021-03-10
-WiFi UART Порт 8080
-Консоль исполнения G кода (на основе сниппетов)
-Обновление ресурсов, прошивки wifi, конфигурационного файла принтера обязателно

2021-03-17
-Скрипт для CURA генерации preview (MKS, Shui, 50x50, 100x100)


2021-03-18
-SHUI preview - полная поддержка
-Журналирование событий (лог сам не обрезается и не архивируется, следует следить за его размером)
-Подтверждение прерывания печати


2021-03-20
-Окно с прогрессом UPLOAD файла
-upload файлов на медленной скорости (115200). Отладка алгоритма. Доступно через http://ip_принетра/
	Временное имя файла после загрузки upload.gco (создание файлов с длинными именами не поддерживается?)

2021-03-24
-UPLOAD на скорости 115200*17 (режим uart-dma) Обновление модуля WiFi обязательно

2021-03-25
-Превью файлов в момент загрузки по WiFi (работает только для превью формата SHUI) (см обновление от 2021-03-17)
-По окончании загрузки через Web страницу, в диалоговом виджете с прогрессом загрузки отображается предложение отправить файл на печать.

2021-03-26
-Marlin 2021-03-25
-Включен BlTouch (не тестировано на принтере). В конфигурации добавлен виджет для задания смещения датчика относительно сопла
    (prev stable)Robin_nano35.bin - предыдущая версия для отката.
    Подключено к Z-MIN

2021-03-29
-Виджет печати, поддержка страничной панели статусов
-babystep (управляется с виджета печати)
-feedrate статус на виджете печати. Можно изменить процент подачи.
	Обновление ресурсов обязательно

2021-03-30
-bltouch -> Z_MAX, парковка по BLTOUCH отключена
-Виджет Уровень стола + режим измерения с bltouch

2021-03-31
-Измерение стола с помощью bltouch. Стол разбивается на 9 квадратов, измерение производится в центре каждого.
-Автоматическое измерение уровня стола по 9 точкам
-Учитываются смещения bltouch заданные в виджете конфигурации уровня стола
-Перед измерением и после измерения передвижение в Z=10


2021-04-01
-Уровень стола. Двойное смещение bltouch (исправлено)
-Ошибка конфигурирование смещения bltouch (исправлено)
-Кириллические символы в именах файлов (linux и windows имеют разные алгоритмы формирования короткого имени. Тестирование linux - OK, win- ????)


2021-04-03
-Marlin 2021-04-03
-Контроль Fat orphan - Marlin 2 не умеет корректно удалять файлы с длинными именами. 
-Файлы прошивки приведены к имени 8.3 (короткие имена файлов)
-Поддержка Upload через WiFi и запуск на печать
-Собственный плагин к CURA и сценарий дополнения G-кода превью
-Опция в настройках "короткие имена файлов" браузер будет отображать имена файлов в формате 8.3


2021-04-03
-Правки "Контроль Fat orphan" приняты в дистрибутив Marlin
-Marlin 2021-04-05
-Обновлена поддержка украинского языка
-В сборку включена конфигурация для принтера two trees bluer
-На виджете "Перемещение" можно отключить концевики (программные и аппаратные одновременно)
==========================================================================

2021-04-06
-Опция "управление концевиками' позволяет скрыть кнопку управления концеиками в виджете "Перемещение"
-Бакап конфигурации (файл GFGBKP.GCO)
-Правки локализации UA

2021-04-09
-Проблемы с длинными именами файлов в M2 привели к изменению суффиксов имен файлов с конфигурацией. Теперь файлы <name>_config должны быть названы @<name>
-Устранение причин, вызыающих ребут при запуске конфигурационных файлов в режиме отображения 8.3
-Настройки концевиков осей, датчики филамента выделены в отдельный раздел конфигурации
-Добавлена конфигурация "особые точки", где можно задать точку смены филамента и смещение точки парковки.
-В виджете "Настройка температуры" можно вызвать виджет "График температур", кторый раньше можно было видеть только при запуске калибровки PID
-Исправлена ошибка экспорта точек ручной настройки стола
-обновление ресурсов обязательно!

2021-04-12
-Большие буквы кириллического шрифта
-переезд https://github.com/vyacheslav-shubin/shui

2021-04-13
-Сброс частных настроек после печати файла. Не относится к конфигурационным файлам (@name.GCO)
  Опция включается в Настройки/Разное
-Подключены сенсоры филамента. В правом верхнем углу появляется приктограмма, сигнализирующая об обрыве. Печать встает на паузу при обрыве. 
  Перед печатью и после паузы проверяется состояние датчиков филамента.
  Опция включается в Настройки/Разное

2021-04-20
-Поддержка превью, если файлы были сохранены с Windows типом перевода строки (\r\n)
-Поддержка варианта платы ROBIN 1.1 (не работал алгоритм прошивки WiFi)
-Файлы прошивки Wifi 0x00000.bin и 0x10000.bin объединены в один SHUIWIFI.BIN
-two_trees_bluer CARTESIAN кинематика
-на виджете перемещения кнопка выключения моторов (для ее работы необходимо однократно запустить файл с определениями сниппетов) @snippets.gcode

2021-04-21
-Сниппет 19 "Отключить моторы". Кнопка добавлена на виджеты Парковка, Уровни, Перемещение, Филамент
-На виджете "G код" пиктограмма сниппет 4, заменена на пиктограмму с клавиатурой, вызывается так же сниппет 51, который при желании может быть переопределен
-Конфигурирование/Разное/Парковка Z по центу
-Конфигурирование/Разное/Управления холодным филаментом
-Увеличены пределы температур экструдера до 300

2021-04-23
-backup исправлена ошибка. В резервировании шаги на мм ось Z заменялась настройками E0
-добавлена отдельная ф-я backup PID
-добавлена настройка включения вентилятора в момент ожидания охлаждения принтера при выключении
-введена новая настройка "Координатные оси", где можно задать диапазон перемещения осей МИН-МАКС. 
  По задумке эта опция позволит задавать область печати и в дальнейшем включить в настройки 
  указания местоположеня концевиков. 
  Реализация этой опции затрагивает алгоритмы вычисления области перемещения в Марлин, и требует тестирования.
  На стенде все поведения кинематики принтера отследить невозможно, предыдущие версии для отката в архивах...
  
2021-04-24 Обновление не затрагивает функционала прошивки.
  -Встроена поддержка настройки цвета фона, шрифта элементов интерфейса
  -В качестве примера приложен файл ресурсов в котором системный экран сообщений имеет темно-красный цвет,
  	а текст в виджете консоли желтый для этого с обновленной прошивкой достаточно прошить файл из папки alt-res

2021-04-25
  -Координаты оси Z выводятся до 2 знака после запятой. 
  -Исправлена ошибка отображения большой картинки печатаемой модели. Ощибка проявлялась в том, что при повторном запуске на печать
   некоторых файлов картинка сжималась в 2-3-4 раза с каждым запуском.
	Большое спасибо всем, кто обратил внимание на эту ощибку, а так же 
   	на особенности ее проявления. Это очень помогает в исправлении и поиске места ошибки
	
2021-04-25 
  -В настройках/разное, появилась опция "Выводить G код в виджет консоли". При ее включении исполняемый G код будет отображаться в соответсвующем виджете
  -Виджет Консоль G-кода добавлен в список инструментов времени печати (аккуратнее с G кодом !! ;) 
  -Начиная с этой версии в прошивке появилась возможность переопределения и дополнения своих G кодов.
  Это означает, что будут появляться необходимые для конфигурирования коды, а поведение некоторых стандартных может быть изменено.
  О всех дополнениях и изменениях буду писать.
  Диапазон кодов M2000-M2100 - коды специфичные для прошивки SHUI. Ранее этот же функционал вводился черех M117 SHUI
  
  M414 - переопределенная стандартная комманда выбора языка интрерфейса
  	параметр S - определяет язык.
	0 - en, 1 - ru, 2 - ua
  M114 S1 ; Выбор русского языка
  
  M2000 - задание размера области печати (стол, высота)
  M2000.1 - минимальные значения
  M2000.2 - максимальные значения
  
  M2000.0 X0 Y0 Z0        ;min axis values
  M2000.1 X225 Y225 Z240  ;max axis values
  
  M2001 - задание инверсии моторов, параметр T определяет для какого экструдера указыватся параметр E
  
  M2001 X1 Y1 Z1 T0 E1    ;Stepper inversion (1 - inverted)
  M2001 T1 E1	; Stepper inversion, extruder 1
  
  M2002 - указание пассивного уровня концевика
  M2002.0 - для концевиков установленных в минимуме оси
  M2002.1 - для концевиков установленных в максимуме оси
  X, Y, Z, E - оси, P - probe
  ;Sensors passive level (1 - vcc / 0 - gnd)
  M2002 T0 E1
  M2002 T1 E1
  M2002.0 X1 Y1 Z1 P1 
  M2002.1 X1 Y1 Z1
  
  |6|7|8|
  |3|4|5|
  |0|1|2|

  M2003 - задание точек ручной регулиновки уровня стола. Всего 9 точек, S - номер точки от 0 до 8
  M2003 S0 X20 Y20
  M2003 S1 X110 Y20
  M2003 S2 X200 Y20
  
  M2003 B20 - модификация этой же команды, где B определяет ширину отступа от края стола, а точки задаются автоматически
  
  Любая из описанных выше команд вызванная без параментров, выведет текущие настройки
  

2021-04-27
  -Обновление большое, потому сначала test-only
  -Вариант andry_hm переименован в ultimaker
  -Пиктограмма парковки по Z работает, для конфигурации с BLTOUCH Z_MIN
  -Бакап использует новый вариант G-кода, старые G коды еще работают, но их поддержка будет удалена
  	если после прошивки параметры принтера будут сброшены, восстановить их можно из ранее сделанного бакапа предыдущей версии.
	Рекомендуется ранее сделанный бакап сохранить отдельно, а после обновления прошивки сделать новый, с новой версией g-кода
	

  Продолжаю добавлять g-код для управления конфигурацией и виджетами
  M2004 - настрока модуля питания
	F - флаги, битовая маска, может быть суммой следующих значений. 
	  1 - Модуль присутсвует,
	  2 - Автоматические выключение по окончании печати
	  4 - Ожидание охлаждения хотэнда
	  8 - Включить вентилятор при ожидании охлаждения
	S - Ожидание перед выключением (0-255 секунд)
	T - Температура до которой должен отсыть хотэнд, перед выключением принтера (0-255 celsius)  
  M2004 F15 S120 T60	
  
  M2005 - Управление сниппетами
    	E - стереть сниппеты
	S - задание номера сниппета
	| после номера и далее - код сниппета
	Сниппеты могут быть стерты из памяти только все сразу.
	Назначение каждого сниппета возможно только один раз после стирания.
	Поэтому, для переназначения сниппета необходимо удалить и записать все текущие используемые.
	Тем не менее, если ранее сниппет с нужным номером не был записан, его можно задать отдельно.
  
  M2005 E ;Eraise snippets
  M2005 S0|G91|G1 X%3.1f F2000|G90        ;MOVE_X_INC 0
  M2005 S1|G91|G1 X-%3.1f F1000|G90       ;MOVE_X_DEC 1
  
  M2006 - вызов виджета
  	W - номер виджета
	С - закрыть виджет
  
  M2006	W9 - отобразить консоль ввода G-кода
  Включая виджет на отображение предыдущий виджет попадает в стек, поэтому вызов
  	M2006 С - приведет к отображению ранее активного виджета.
  Размер стека виджетов ограничен 5!
  	Особые номера:
	M2006 W0 - стартовый виджет (стек виждетов будет обнулен)
	M2006 W-1 - возврат по стеку, аналогичен  M2006 С
  
  M2007 - флаги состояния (для отладки)
  
  M2008 - Задание точки смены филамента
  	M2008 X20 Y20 Z20 E5 F1000 (x, y - абсолютная координата, z - относительная. 
	e - втягивание пластика перед сменой, F - скорость перемещения к точке смены (m/min) )

  M2009 - задание параметров модуля WIFI
  	M - (mode) тип модуля 1 - станция, 2 - точка доступа, 0 - отключен
	T - смещение времени NTP
	H - (hold) модуль временно не используется (0/1)
  M2009.1 - для модуля в режиме станции
  M2009.2 - для модуля в режиме точки доступа
  	S - SSID
	P - пароль
	
  	M2009.1 S:HOME_NETWORK P:pleaseplease
  	M2009.2 S:SHUI P:pleaseplease
	M2009 H0 M1 T180
	
	;Вариат конфигурирования модуля с "шифрованием" пароля
	M2009.1 CH:B2B16F79D0D4D155A8B7230151D7043B23FBE8DFB8081F0EC72C61
	M2009.2 CH:D2EFDD5DEDFBBDE6686A5D862B15E5CA2A3730102405
  
Требуется решить:
-проблемы с длинными именами файлов. Библиотка работы с fat в Marlin 2 не поддерживает создание/переименование файлов с длинными именами?


